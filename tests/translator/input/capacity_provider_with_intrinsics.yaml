AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CapacityProvider with intrinsic functions test

Parameters:
  CapacityProviderName:
    Type: String
    Default: intrinsic-capacity-provider

  SecurityGroupId:
    Type: String
    Default: sg-12345678

  SubnetId:
    Type: String
    Default: subnet-12345678

  Architecture:
    Type: String
    Default: arm64

  AllowedInstanceType:
    Type: String
    Default: c5.xlarge

  ExcludedInstanceType:
    Type: String
    Default: t2.micro

  MaxVCpuCount:
    Type: Number
    Default: 10

  TargetCPU:
    Type: Number
    Default: 75.0

  TargetMemory:
    Type: Number
    Default: 81.2

  KmsKeyArn:
    Type: String
    Default: arn:aws:kms:us-east-1:123456789012:key/abcd1234-ef56-gh78-ij90-klmnopqrstuv

Resources:
  IntrinsicCapacityProvider:
    Type: AWS::Serverless::CapacityProvider
    Properties:
      CapacityProviderName: !Ref CapacityProviderName
      VpcConfig:
        SecurityGroupIds:
        - !Ref SecurityGroupId
        SubnetIds:
        - !Ref SubnetId
      Tags:
        Environment: !Sub "${AWS::StackName}-environment"
        Team: !Sub "${AWS::StackName}-team"
      InstanceRequirements:
        Architectures:
        - !Ref Architecture
        AllowedTypes:
        - !Ref AllowedInstanceType
        - !Join [., [c5, 2xlarge]]
      ScalingConfig:
        MaxVCpuCount: !Ref MaxVCpuCount
        AverageCPUUtilization: !Ref TargetCPU
      KmsKeyArn: !Ref KmsKeyArn
