AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CapacityProvider with custom permissions configuration test

Resources:
  # Create custom roles that match what SAM would generate
  CustomPermissionsCapacityProviderOperatorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CapacityProviderOperatorRolePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - ec2:TerminateInstances
            - ec2:RunInstances
            - ec2:DescribeInstanceStatus
            - ec2:DescribeInstances
            - ec2:CreateTags
            Resource:
            - !Sub arn:${AWS::Partition}:ec2:*:*:instance/*
            - !Sub arn:${AWS::Partition}:ec2:*:*:network-interface/*
            - !Sub arn:${AWS::Partition}:ec2:*:*:volume/*
            Condition:
              StringEquals:
                ec2:ManagedResourceOperator: scaler.lambda.amazonaws.com
          - Effect: Allow
            Action:
            - ec2:DescribeAvailabilityZones
            - ec2:DescribeCapacityReservations
            - ec2:DescribeInstanceTypeOfferings
            - ec2:DescribeInstanceTypes
            - ec2:DescribeSecurityGroups
            - ec2:DescribeSubnets
            Resource: '*'
          - Effect: Allow
            Action:
            - ec2:RunInstances
            - ec2:CreateNetworkInterface
            Resource:
            - !Sub arn:${AWS::Partition}:ec2:*:*:subnet/*
            - !Sub arn:${AWS::Partition}:ec2:*:*:security-group/*
          - Effect: Allow
            Action:
            - ec2:RunInstances
            Resource:
            - !Sub arn:${AWS::Partition}:ec2:*:*:image/*
            Condition:
              Bool:
                ec2:Public: 'true'
      Tags:
      - Key: lambda:createdBy
        Value: SAM

  # Reference the custom roles in the capacity provider
  CustomPermissionsCapacityProvider:
    Type: AWS::Serverless::CapacityProvider
    Properties:
      CapacityProviderName: custom-permissions-provider
      VpcConfig:
        SecurityGroupIds:
        - sg-12345678
        SubnetIds:
        - subnet-12345678
      OperatorRole: !GetAtt CustomPermissionsCapacityProviderOperatorRole.Arn
